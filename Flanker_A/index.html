<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlankerGame (Arrows Only)</title>
  <style>
    :root{ --bg:#000; --fg:#fff; --muted:#bbb; --warn:#e74c3c; --maxw:1000px; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    #app{min-height:100%;display:grid;place-items:center}
    .screen{width:100%;max-width:var(--maxw);padding:24px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;gap:24px;text-align:center}
    .btn{background:#444;border:2px solid #fff;color:#fff;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#666}
    .row{display:flex;gap:16px;align-items:center;justify-content:center}
    .stimulus{display:grid;grid-template-columns:repeat(5, minmax(60px, 120px));gap:16px;align-items:center;justify-items:center}
    .fix{font-size:120px;line-height:1;}
    .kbdhelp{position:fixed;top:16px;left:16px;display:flex;align-items:center;gap:8px;border:2px solid #fff;padding:8px 12px;border-radius:12px;pointer-events:none;z-index:1}
    .kbdhelp.right{left:auto;right:16px}
    .kbdkey{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-weight:700}
    .kbdarrow{font-size:22px}
    .subtle{color:var(--muted);font-size:14px}
    .warn{color:var(--warn);font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .count{font-size:56px}
    .foot{opacity:.8}
    .hide-cursor { cursor: none; }
  </style>
</head>
<body>
<div id="app"></div>

<script>
/*******************
 * CONFIG
 *******************/
const CONFIG = {
  scheduleCSV: 'flanker_schedule_mini.csv', // your attached schedule
  practiceTrials: 8,
  fixationMs: 500,
  blankMs: 500,
  timeoutMs: 2000,
  tooFastMs: 150,
  breakEvery: 1,
  breakSeconds: 10,
  showKeyCues: true
};

/*******************
 * STATE
 *******************/
const state = {
  screen: 'welcome',
  trials: [],
  practice: [],
  block: [],
  idx: 0,
  inPractice: true,
  awaiting: null,
  tStart: 0,
  responses: [],
  pid: new URLSearchParams(location.search).get('PID') || 'TEST',
  _timeoutTimer: null,
  _needsRequeue: false,
  _posted: false
};

/*******************
 * UTIL
 *******************/
const $ = sel => document.querySelector(sel);
const app = $('#app');

function clean(v){
  return String(v ?? '')
    .replace(/^\uFEFF/, '')   // strip BOM if present
    .trim()
    .replace(/^"(.*)"$/,'$1')
    .replace(/^'(.*)'$/,'$1');
}
function tokenToDir(src){
  const s = clean(src).toLowerCase();
  if (['l','left','←','<'].includes(s)) return 'left';
  if (['r','right','→','>'].includes(s)) return 'right';
  return null; // unknown token
}

function h(tag, attrs={}, ...kids){
  const el = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
     if(k==='class') el.className = v;
     else if(k==='html') el.innerHTML = v;
     else if(/^on/.test(k) && typeof v === 'function') el[k] = v;
     else el.setAttribute(k,v);
  });
  kids.flat().forEach(k=>{
     if(k==null) return;
     if(typeof k==='string') el.appendChild(document.createTextNode(k));
     else el.appendChild(k);
  });
  return el;
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

function parseCSV(text){
  const rows = text.trim().split(/\r?\n/);
  if (!rows.length) return [];

  const header = rows.shift().split(',').map(s=>s.trim().toLowerCase());
  const idx = (name)=> header.indexOf(name);

  const iFlanker = idx('flanker');
  const iTarget  = idx('target');
  const iCorrect = idx('correct');
  const iCong    = idx('congruency');
  const iType    = idx('type');

  const out = [];
  for(const line of rows){
    if(!line.trim()) continue;
    const cols = line.split(',').map(s=>String(s).trim());

    const flk = (iFlanker>=0 ? cols[iFlanker] : '').trim();
    const tgt = (iTarget >=0 ? cols[iTarget]  : '').trim();
    if (!(flk === '<' || flk === '>')) continue;
    if (!(tgt === '<' || tgt === '>')) continue;

    // Build the 5-arrow display: flanker, flanker, target, flanker, flanker
    const images = [flk, flk, tgt, flk, flk];

    // Use provided correct if present; otherwise derive (Q for <, P for >)
    let corr = iCorrect>=0 ? String(cols[iCorrect]||'').trim().toUpperCase() : '';
    if (!corr) corr = (tgt === '<') ? 'Q' : 'P';

    out.push({
      images,
      correct: corr,
      congruency: iCong>=0 ? String(cols[iCong]||'').trim() : '',
      type: iType>=0 ? String(cols[iType]||'exp').trim().toLowerCase() : 'exp'
    });
  }

  console.log('Parsed trials:', out.length);
  return out;
}



/*******************
 * RENDERERS
 *******************/
function render(){
  const s = state.screen;
  document.body.classList.toggle('hide-cursor', ['fix','blank','stim'].includes(s));
  app.innerHTML = '';

  if(CONFIG.showKeyCues && (['practice','main','fix','blank','stim','tooFast','tooSlow','inst1','inst2','inst3','practiceIntro'].includes(s))){
    app.append(
      h('div',{class:'kbdhelp'},
        h('span',{class:'kbdkey'},'Q'),' = LEFT ', h('span',{class:'kbdarrow'},'←')
      ),
      h('div',{class:'kbdhelp right'},
        h('span',{class:'kbdkey'},'P'),' = RIGHT ', h('span',{class:'kbdarrow'},'→')
      )
    );
  }

  const container = h('div',{class:'screen'});
  app.append(container);

  if(s==='welcome'){
    container.append(
      h('h1',{},'Welcome to the Arrow Game!'),
      h('p',{},'This task will take about 20 minutes. Please read the instructions carefully. Press Continue to proceed.'),
      h('button',{class:'btn',onclick:()=>go('inst1')},'Continue')
    );
  }
  else if(s==='inst1'){
    container.append(
      h('div',{class:'stimulus'}, ...[0,1,2,3,4].map(()=> arrowCell('left'))),
      h('h2',{style:'margin:1px 0'},'Task Instructions'),
      h('div',{},
        h('p',{style:'margin:1px 0'},'You will see five arrows in a row. Your job is to judge the direction of the ', h('b',{},'MIDDLE'),' arrow only.'),
        h('p',{style:'margin:1px 0'}, h('span',{class:'mono'},'Q'),' = LEFT. ', h('span',{class:'mono'},'P'),' = RIGHT.')
      ),
      h('button',{class:'btn',onclick:()=>go('inst2')},'Continue')
    );
  }
  else if(s==='inst2'){
    container.append(
      h('div',{class:'stimulus'}, arrowCell('left'),arrowCell('left'),arrowCell('right'),arrowCell('left'),arrowCell('left')),
      h('h2',{style:'margin:1px 0'},'Important'),
      h('p',{style:'margin:1px 0'},'Sometimes the surrounding arrows will point in a different direction than the arrow in the middle.'),
      h('p',{style:'margin:1px 0'},'Only pay attention to the MIDDLE arrow!'),
      h('p',{style:'margin:1px 0'},'Press Continue to read further instruction.'),
      h('button',{class:'btn',onclick:()=>go('inst3')},'Continue')
    );
  }
  else if(s==='inst3'){
    container.append(
      h('h2',{style:'margin:1px 0'},'Examples'),
      h('p',{style:'margin:1px 0'},'In the example below, the left [Q]-key is correct:'),
      h('div',{class:'stimulus'}, ...[0,1,2,3,4].map(()=> arrowCell('left'))),
      h('p',{style:'margin:1px 0'},'since the middle arrow points left.'),
      h('p',{style:'margin:1px 0'},'In the example below, the right [P]-key is correct:'),
      h('div',{class:'stimulus'}, arrowCell('left'),arrowCell('left'),arrowCell('right'),arrowCell('left'),arrowCell('left')),
      h('p',{style:'margin:1px 0'},'since the middle arrow points right.'),
      h('p',{style:'margin:1px 0'},'Press Continue for further instruction.'),
      h('button',{class:'btn',onclick:()=>go('practiceIntro')},'Continue')
    );
  }
  else if(s==='practiceIntro'){
    container.append(
      h('h2',{},'Practice'),
      h('p',{},'Place your index fingers on ', h('b',{},'Q'),' and ', h('b',{},'P'),'. Respond as quickly and accurately as possible.'),
      h('p',{class:'subtle'},'Press Space to begin the practice block.')
    );
  }
  else if(s==='fix'){
    container.append(h('div',{class:'fix'},'+'));
  }
  else if(s==='blank'){
    container.append(h('div',{class:'fix',style:'opacity:.0'},'+'));
  }
  else if(s==='stim'){
    const trial = currentTrial();
    container.append(
      h('div',{class:'stimulus'},
        ...trial.images.map((tok, i)=>{
          const dir = tokenToDir(tok);
          return arrowCell(dir || 'left'); // fallback to left if token is bad
        })
      )
    );
  }
  else if(s==='tooFast'){
    container.append(h('div',{class:'warn'},'Too fast! Press Space to continue.'));
  }
  else if(s==='tooSlow'){
    container.append(h('div',{class:'warn'},'Too slow! Press Space to continue.'));
  }
  else if(s==='practiceBreak'){
    container.append(
      h('h2',{},'Experiment'),
      h('p',{},'Practice complete. Start the main block or practice more.'),
      h('div',{class:'row'},
        h('button',{class:'btn',onclick:startMain},'Start'),
        h('button',{class:'btn',onclick:restartPractice},'Practice More')
      )
    );
  }
  else if(s==='break'){
    container.append(h('h2',{},'Break Time!'));
    container.append(h('div',{id:'breakCount',class:'count'},''+state._breakRemaining));
    container.append(h('p',{class:'foot'},`Resuming automatically...`));
  }
  else if(s==='done'){
    ensurePosted();
    container.append(h('h2',{},'All done!'));
  }
}

function arrowCell(dir){
  const svgLeft  = `<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>`;
  const svgRight = `<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`;
  const svg = dir==='right' ? svgRight : svgLeft;
  return h('div', {style:'width:100px;height:100px;display:grid;place-items:center'}, h('div',{html: svg}));
}
function currentTrial(){ return state.inPractice ? state.practice[state.idx] : state.block[state.idx]; }

/*******************
 * FLOW
 *******************/
function go(next){ state.screen = next; render(); }

async function runTrial(){
  if(state._timeoutTimer){ clearTimeout(state._timeoutTimer); state._timeoutTimer = null; }
  state.awaiting = null; go('fix'); await sleep(CONFIG.fixationMs);
  go('blank'); await sleep(CONFIG.blankMs);
  state.awaiting = 'resp';
  go('stim');
  state.tStart = performance.now();
  state._timeoutTimer = setTimeout(handleTooSlow, CONFIG.timeoutMs + 10);
}

function recordResponse(key){
  if(state._timeoutTimer){ clearTimeout(state._timeoutTimer); state._timeoutTimer = null; }
  if(state.awaiting !== 'resp') return;
  const t = currentTrial();
  const rt = performance.now() - state.tStart;
  let flag = null;
  if(rt < CONFIG.tooFastMs) flag = 'tooFast';
  else if(rt > CONFIG.timeoutMs) flag = 'tooSlow';
  const resp = {
    trial: (state.inPractice? 'P':'M') + (state.idx+1),
    response: key||null,
    rt: Math.round(rt),
    correct: key ? (key===t.correct) : false,
    congruency: t.congruency,
    target: t.images[2],
    pid: state.pid,
    flag,
    lapse: !!flag,
    lapseType: flag || null
  };
  state.responses.push(resp);
  if(flag==='tooFast'){ state._needsRequeue = true; state.awaiting='space'; go('tooFast'); }
  else if(flag==='tooSlow'){ state._needsRequeue = true; state.awaiting='space'; go('tooSlow'); }
  else nextTrial();
}

function requeueCurrentTrial(){
  const list = state.inPractice ? state.practice : state.block;
  if(state.idx < list.length){
    const [curr] = list.splice(state.idx, 1);
    if(curr) list.push(curr);
  }
}
function handleTooSlow(){
  if(state.awaiting !== 'resp') return;
  state.awaiting = 'space';
  const t = currentTrial();
  const resp = {
    trial: (state.inPractice? 'P':'M') + (state.idx+1),
    response: null,
    rt: CONFIG.timeoutMs,
    correct: false,
    congruency: t && t.congruency,
    target: t && t.images ? t.images[2] : null,
    pid: state.pid,
    flag: 'tooSlow',
    lapse: true,
    lapseType: 'tooSlow'
  };
  state.responses.push(resp);
  state._needsRequeue = true;
  go('tooSlow');
}
function nextTrial(){
  state.idx++;
  const total = state.inPractice ? state.practice.length : state.block.length;
  if(!state.inPractice && CONFIG.breakEvery>0 && state.idx>0 && state.idx%CONFIG.breakEvery===0 && state.idx<total){
    startBreak(); return;
  }
  if(state.idx>=total){
    if(state.inPractice){ state.inPractice=false; state.idx=0; go('practiceBreak'); }
    else { go('done'); }
  }else{
    runTrial();
  }
}
function startBreak(){
  state._breakRemaining = CONFIG.breakSeconds;
  go('break');
  state._breakTimer = setInterval(()=>{
    state._breakRemaining-=1;
    const el=$('#breakCount'); if(el) el.textContent = ''+state._breakRemaining;
    if(state._breakRemaining<=0){ clearInterval(state._breakTimer); runTrial(); }
  }, 1000);
}
function restartPractice(){ state.inPractice = true; state.idx=0; go('practiceIntro'); }
function startMain(){ state.inPractice = false; state.idx=0; runTrial(); }

/*******************
 * QUALTRICS POST
 *******************/
let __RG_DONE_SENT__ = false;
function sendRGDoneOnce(payload) {
  if (__RG_DONE_SENT__) return;
  __RG_DONE_SENT__ = true;
  try {
    window.parent.postMessage({ type: 'RG_DONE_Arrows', payload }, '*');
    console.log('postMessage sent:', payload);
  } catch (e) {
    console.error('postMessage failed:', e);
  }
}
function endGame() {
  const results = state.responses.slice();
  const nTrials = results.length;
  const nLapses = results.filter(r => r.lapse).length;
  const rts = results.filter(r => !r.lapse && typeof r.rt === 'number').map(r => r.rt);
  const meanRT = rts.length ? Math.round(rts.reduce((a,b)=>a+b,0)/rts.length) : null;
  const nAttention = 0;
  const nAttentionPassed = 0;
  const payload = {
    task: 'flanker_arrows',
    participantID: state.pid,
    results,
    summary: { nTrials, nLapses, meanRT, nAttention, nAttentionPassed }
  };
  sendRGDoneOnce(payload);
}
function ensurePosted(){ if(!state._posted){ endGame(); state._posted = true; } }

/*******************
 * INPUT
 *******************/
window.addEventListener('keydown', (e)=>{
  const k = e.key.toUpperCase();
  if(state.screen==='practiceIntro' && k===' '){ state.idx=0; runTrial(); }
  else if((state.screen==='tooFast'||state.screen==='tooSlow') && k===' ' && state.awaiting==='space'){
    if(state._needsRequeue){ requeueCurrentTrial(); state._needsRequeue=false; }
    state.awaiting=null; nextTrial();
  }
  else if((state.screen==='stim') && state.awaiting==='resp' && (k==='Q'||k==='P')){ recordResponse(k); }
});

/*******************
 * BOOT
 *******************/
async function boot(){
  render();
  try {
    const res = await fetch(CONFIG.scheduleCSV);
    if (!res.ok) throw new Error('CSV not found');
    const text = await res.text();
    const allTrials = parseCSV(text);
    console.log('Loaded trials:', allTrials.length);
    if (!allTrials || allTrials.length === 0) throw new Error('No trials parsed');

    // Split by type; fallback if no practice rows
    const prac = allTrials.filter(t => (t.type||'').toLowerCase().startsWith('p'));
    const exp  = allTrials.filter(t => !(t.type||'').toLowerCase().startsWith('p'));
    state.trials = allTrials;

    if (prac.length === 0){
      state.practice = CONFIG.practiceTrials ? allTrials.slice(0, CONFIG.practiceTrials) : [];
      state.block    = CONFIG.practiceTrials ? allTrials.slice(CONFIG.practiceTrials) : allTrials;
    } else {
      state.practice = CONFIG.practiceTrials ? prac.slice(0, CONFIG.practiceTrials) : prac;
      state.block    = exp;
    }
  } catch (err) {
    console.warn('CSV issue, using tiny token demo. Details:', (err && err.message) ? err.message : err);
    state.trials = [
      {images:['L','L','L','L','L'], correct:'Q', congruency:'congruent', type:'prac'},
      {images:['L','L','R','L','L'], correct:'P', congruency:'incongruent', type:'exp'}
    ];
    state.practice = state.trials.slice(0,1);
    state.block = state.trials.slice(1);
  }
}
boot();
</script>
</body>
</html>
